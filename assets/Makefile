# Friends don't let friends fool around with Makefiles :)
TARGETDIR := build/
SOURCEDIR := ./
OUTPUT_HEADER_NAME ?= assets.generated.h
OUTPUT_MK_NAME ?= assets.generated.mk
FIRSTBANK ?= 2
PREFIX := 

assets := $(wildcard $(SOURCE_DIR)*)
header_file := $(TARGETDIR)assets.generated.h
mk_file := $(TARGETDIR)assets.generated.mk
stage_dir := $(TARGETDIR)stage/
built_assets := $(stage_dir)assets2banks.cfg # will be appeneded by following transform rules

.PHONY: assets
assets: $(header_file)

$(stage_dir):
	$(MKDIR) $@

#################################
# Add asset transform rules here
#################################

# the following extensions will be directly copied without transformation
direct_copy_extensions := %.bin %.psg

# convert vgm -> psg
$(stage_dir)%.psg: $(SOURCEDIR)%.vgm | $(stage_dir)
	vgm2psg $< $@
	retcon-audio psg $@ $@
built_assets += $(patsubst %.vgm,$(stage_dir)%.psg,$(filter %.vgm,$(assets)))

#################
# Asset bundling
#################

$(stage_dir)assets2banks.cfg: $(SOURCEDIR)assets2banks.cfg | $(stage_dir)
	cp $< $@

direct_copies := $(patsubst %,$(stage_dir)%,$(filter $(direct_copy_extensions),$(assets)))
$(direct_copies): $(stage_dir)%: % | $(stage_dir)
	cp $< $@
built_assets += $(direct_copies)

$(header_file) $(mk_file): $(built_assets) $(assets) $(SOURCEDIR)*
	-cd $(TARGETDIR) && assets2banks ./stage --firstbank=$(FIRSTBANK) --allowsplitting --singleheader=$(OUTPUT_HEADER_NAME)
	> $(mk_file)
	@for f in $(TARGETDIR)bank*.c; do \
		[ -f "$$f" ] || continue; \
		b=`basename $$f`; \
		t="$(TARGETDIR)assets.generated.$${b}"; \
		echo "$(PREFIX)$(header_file): $(PREFIX)$$t" >> $(mk_file); \
		echo '// This file is automatically generated - do not modify!' > $$t; \
		echo "" >> $$t; \
		cat $$f >> $$t; \
		echo "Removing $$f"; \
		rm $$f; \
	done
	touch $(header_file)

.PHONY: clean
clean:
	rm -rf $(TARGETDIR)
